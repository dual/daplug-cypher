version: 2.1
orbs:
    python: circleci/python@3.3.0
    sonarcloud: sonarsource/sonarcloud@3.0.1
commands:
    setup-artifacts:
        steps:
            - run: mkdir -p ./coverage && mkdir -p ./coverage/lint && mkdir -p ./coverage/reports && mkdir -p ./coverage/pretty && mkdir -p ./coverage/typing || exit 0
    python-neo4j-tests:
        steps:
            - run:
                name: Run Neo4j marker suite
                command: pipenv run test_neo4j
                environment:
                    NEO4J_BOLT_URL: bolt://localhost:7687
                    NEO4J_USER: neo4j
                    NEO4J_PASSWORD: password
    python-neptune-tests:
        steps:
            - run:
                name: Run Neptune marker suite
                command: pipenv run test_neptune
                environment:
                    NEPTUNE_BOLT_URL: bolt://localhost:8687
                    NEPTUNE_USER: neo4j
                    NEPTUNE_PASSWORD: password
                    NEO4J_BOLT_URL: bolt://localhost:7687
                    NEO4J_USER: neo4j
                    NEO4J_PASSWORD: password
    python-all-tests:
        steps:
            - run:
                name: Run full test suite with coverage
                command: pipenv run coverage
                environment:
                    NEO4J_BOLT_URL: bolt://localhost:7687
                    NEO4J_USER: neo4j
                    NEO4J_PASSWORD: password
                    NEPTUNE_BOLT_URL: bolt://localhost:8687
                    NEPTUNE_USER: neo4j
                    NEPTUNE_PASSWORD: password
            - store_artifacts:
                path: ./coverage
            - store_test_results:
                path: ./coverage/reports
    lint-code:
        steps:
            - run: pipenv run lint
            - run: pipenv run pylint daplug_cypher --output-format=json > ./coverage/lint/pylint_report.json || exit 0
            - run: pipenv run pylint-json2html ./coverage/lint/pylint_report.json -o ./coverage/lint/pylint_report.html || exit 0
            - store_artifacts:
                path: ./coverage/lint
    typecheck-test:
        steps:
            - run: pipenv run typecheck
            - run: pipenv run typecheck-report
            - store_artifacts:
                path: ./coverage/typing
    sync-packaging:
        steps:
            - run: pipenv run setup-sync
    pypi-setup:
        steps:
            - run: echo -e "[pypi]" >> ~/.pypirc
            - run: echo -e "username = __token__" >> ~/.pypirc
            - run: echo -e "password = $PYPI_TOKEN" >> ~/.pypirc
    pypi-publish:
        steps:
            - run: python3 -m pip install --user --upgrade setuptools wheel
            - run: python3 setup.py sdist bdist_wheel
            - run: python3 -m pip install --user --upgrade twine
            - run: python3 -m twine upload dist/*
    python-build-dist:
        steps:
            - run: pipenv run python -m pip install --upgrade pip build
            - run: pipenv run python -m build
            - run: pipenv requirements --dev > dev-requirements.txt
    python-test-dist:
        steps:
            - run: python -m venv /tmp/package-smoke
            - run: /tmp/package-smoke/bin/pip install --upgrade pip
            - run: /tmp/package-smoke/bin/pip install -r dev-requirements.txt
            - run: /tmp/package-smoke/bin/pip install dist/*.whl
            - run: /tmp/package-smoke/bin/python -m pytest ~/project/tests/unit
            - run:
                environment:
                    NEO4J_BOLT_URL: bolt://localhost:7687
                    NEO4J_USER: neo4j
                    NEO4J_PASSWORD: password
                    NEPTUNE_BOLT_URL: bolt://localhost:7687
                    NEPTUNE_USER: neo4j
                    NEPTUNE_PASSWORD: password
                working_directory: /tmp
                command: /tmp/package-smoke/bin/python -m pytest ~/project/tests -m "neo4j or neptune"
jobs:
    install-build:
        docker:
            - image: cimg/python:3.9.17
        steps:
            - checkout:
                  method: full
            - python/install-packages:
                pkg-manager: pipenv
                args: '--dev'
            - persist_to_workspace:
                root: ~/project
                paths:
                    - ./*
    lint:
        docker:
            - image: cimg/python:3.9.17
        steps:
            - attach_workspace:
                at: ~/project
            - setup-artifacts
            - lint-code
    type-check:
        docker:
            - image: cimg/python:3.9.17
        steps:
            - attach_workspace:
                at: ~/project
            - setup-artifacts
            - typecheck-test
    test-neo4j:
        docker:
            - image: cimg/python:3.9.17
            - image: neo4j:5.18
              environment:
                  NEO4J_AUTH: neo4j/password
        steps:
            - attach_workspace:
                at: ~/project
            - setup-artifacts
            - python-neo4j-tests
    test-neptune:
        docker:
            - image: cimg/python:3.9.17
            - image: neo4j:5.18
              environment:
                  NEO4J_AUTH: neo4j/password
            - image: neo4j:5.18
              environment:
                  NEO4J_AUTH: neo4j/password
                  NEO4J_dbms_connector_bolt_listen__address: ":8687"
                  NEO4J_dbms_connector_bolt_advertised__address: "localhost:8687"
                  NEO4J_dbms_connector_http_enabled: "false"
                  NEO4J_dbms_connector_https_enabled: "false"
            - image: localstack/localstack:latest
              environment:
                  SERVICES: neptune
                  DEBUG: 1
        steps:
            - attach_workspace:
                at: ~/project
            - setup-artifacts
            - python-neptune-tests
    test-all:
        docker:
            - image: cimg/python:3.9.17
            - image: neo4j:5.18
              environment:
                  NEO4J_AUTH: neo4j/password
            - image: neo4j:5.18
              environment:
                  NEO4J_AUTH: neo4j/password
                  NEO4J_dbms_connector_bolt_listen__address: ":8687"
                  NEO4J_dbms_connector_bolt_advertised__address: "localhost:8687"
                  NEO4J_dbms_connector_http_enabled: "false"
                  NEO4J_dbms_connector_https_enabled: "false"
            - image: localstack/localstack:latest
              environment:
                  SERVICES: neptune
                  DEBUG: 1
        steps:
            - attach_workspace:
                at: ~/project
            - setup-artifacts
            - python-all-tests
            - sonarcloud/scan
    install-build-publish:
        docker:
            - image: cimg/python:3.9.17
        steps:
            - checkout:
                  method: full
            - python/install-packages:
                pkg-manager: pipenv
                args: '--dev'
            - sync-packaging
            - pypi-setup
            - pypi-publish
    package-smoke-test:
        docker:
            - image: cimg/python:3.9.17
            - image: neo4j:5.18
              environment:
                  NEO4J_AUTH: neo4j/password
        steps:
            - attach_workspace:
                at: ~/project
            - python-build-dist
            - python-test-dist
workflows:
    install-build-publish-workflow:
        jobs:
            - install-build-publish:
                context:
                    - pipenv
                filters:
                    tags:
                        only: /.*/
                    branches:
                        ignore: /.*/
    install-build-test-workflow:
        jobs:
            - install-build:
                context:
                    - pipenv
            - lint:
                requires:
                    - install-build
            - type-check:
                requires:
                    - install-build
            - test-neo4j:
                requires:
                    - install-build
            - test-neptune:
                requires:
                    - install-build
            - test-all:
                requires:
                    - install-build
                context:
                    - sonarcloud
            - package-smoke-test:
                requires:
                    - install-build
